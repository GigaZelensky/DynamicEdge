name: Build DynamicEdge

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Environment Variables
      run: |
        echo "APP_VERSION=1.0.2" >> $env:GITHUB_ENV

    - name: Compile Application
      shell: powershell
      run: |
        # 1. Robustly locate the latest .NET Framework 4.x directory
        $frameworkPath = Join-Path $env:windir "Microsoft.NET\Framework64"
        $latestVersion = Get-ChildItem -Path $frameworkPath -Filter "v4*" | 
                         Sort-Object Name -Descending | 
                         Select-Object -First 1
        
        if (-not $latestVersion) {
            Write-Error "Could not find .NET Framework v4 directory in $frameworkPath"
            exit 1
        }

        $csc = Join-Path $latestVersion.FullName "csc.exe"

        Write-Host "Using Framework Dir: $($latestVersion.FullName)"
        Write-Host "Compiler Path: $csc"

        if (-not (Test-Path $csc)) {
            Write-Error "csc.exe not found at $csc"
            exit 1
        }

        # 2. Define Output Names
        $outName = "DynamicEdge-$env:APP_VERSION.exe"
        $configName = "$outName.config"
        
        # 3. Compile
        # Equivalent to: csc /target:winexe /unsafe /r:... /out:... /win32manifest:... src\*.cs
        $buildArgs = @(
            "/target:winexe",
            "/unsafe",
            "/r:System.Windows.Forms.dll",
            "/r:System.Drawing.dll",
            "/r:System.Runtime.Serialization.dll",
            "/out:$outName",
            "/win32manifest:app.manifest",
            "src\*.cs"
        )
        
        Write-Host "Running: $csc $buildArgs"
        & $csc $buildArgs

        # 4. Handle Config File
        if (Test-Path "src\app.config") {
            Copy-Item "src\app.config" -Destination $configName
            Write-Host "Config copied."
        }

        # 5. Verify Build
        if (Test-Path $outName) {
            Write-Host "Build Success: $outName"
        } else {
            Write-Error "Build Failed: Output file not created."
            exit 1
        }

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DynamicEdge-Release
        path: |
          DynamicEdge-*.exe
          DynamicEdge-*.exe.config
          README.md
          LICENSE
